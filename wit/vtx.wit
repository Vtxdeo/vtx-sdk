package vtx:api@1.2.0;

/// --- SQL 接口定义 ---
/// 提供基础 SQL 语句执行与 JSON 查询能力
interface sql {
    /// 支持的数据库值类型
    variant db-value {
        text(string),
        integer(s64),
        real(f64),
        null-val,
    }

    /// 执行写类语句 (INSERT/UPDATE/DELETE)，返回影响行数或错误信息
    execute: func(statement: string, params: list<db-value>) -> result<u64, string>;

    /// 执行 SELECT 并返回 JSON 序列化结果
    query-json: func(statement: string, params: list<db-value>) -> result<string, string>;
}

/// --- Stream IO 接口定义 ---
/// 支持文件与内存缓冲区访问
interface stream-io {
    resource buffer {
        /// 获取资源总字节大小
        size: func() -> u64;

        /// 从指定偏移读取数据
        read: func(offset: u64, max-bytes: u64) -> list<u8>;
    }

    /// 打开已注册视频资源文件（按 UUID 查询）
    open-file: func(uuid: string) -> result<buffer, string>;

    /// 创建内存缓冲区资源（返回 buffer 资源句柄）
    create-memory-buffer: func(data: list<u8>) -> buffer;
}

/// --- 鉴权类型定义 ---
/// 用户上下文结构，作为身份认证结果返回
interface auth-types {
    record user-context {
        user-id: string,        // 用户唯一标识
        username: string,       // 用户显示名
        groups: list<string>,   // 所属角色或权限组
        metadata: string,       // 附加元数据（建议为 JSON）
    }
}

/// --- 通用类型定义 ---
interface types {
    use stream-io.{buffer};
    use auth-types.{user-context};

    record http-request {
        method: string,
        path: string,
        query: string,
    }

    record http-response {
        status: u16,
        body: option<buffer>,
    }

    record manifest {
        id: string,
        name: string,
        version: string,
        description: string,
        entrypoint: string,
    }
}

/// --- 插件接口入口定义 ---
world plugin {
    use types.{http-request, http-response, manifest};
    use auth-types.{user-context};

    import stream-io;
    import sql;

    /// 业务请求处理（插件主入口）
    export handle: func(req: http-request) -> http-response;

    /// 数据迁移脚本（按版本顺序）
    export get-migrations: func() -> list<string>;

    /// 插件清单信息
    export get-manifest: func() -> manifest;

    /// 插件声明的数据库资源（如表名）
    export get-resources: func() -> list<string>;

    /// 插件身份验证接口
    ///
    /// - 输入：HTTP 请求头部 (键值对列表)
    /// - 成功：返回用户上下文
    /// - 失败：返回 HTTP 状态码（如 401, 403）
    export authenticate: func(headers: list<tuple<string, string>>) -> result<user-context, u16>;
}
